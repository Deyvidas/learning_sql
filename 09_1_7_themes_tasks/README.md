- [Вложенный под-запрос (n x n)](#3)

<!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ -->

---

<h3 id="1" align="center">Задание 1</h3>

Занести в таблицу fine суммы штрафов, которые должен оплатить водитель, в
соответствии с данными из таблицы traffic_violation. При этом суммы заносить
только в пустые поля столбца sum_fine.

```sql
UPDATE fine AS f,
       traffic_violation AS tv
   SET f.sum_fine = tv.sum_fine
 WHERE ISNULL(f.sum_fine)
   AND tv.violation LIKE f.violation;
```

<details><br><summary>Таблицы до</summary>

```sql
SELECT * FROM traffic_violation;
```
```text
violation_id|violation                       |sum_fine|
------------+--------------------------------+--------+
           1|Превышение скорости(от 20 до 40)|  500.00|
           2|Превышение скорости(от 40 до 60)| 1000.00|
           3|Проезд на запрещающий сигнал    | 1000.00|
```

<p align="center">~~~</p>

```sql
SELECT * FROM fine;
```
```text
fine_id|name         |number_plate|violation                       |sum_fine|date_violation|date_payment|
-------+-------------+------------+--------------------------------+--------+--------------+------------+
      1|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)|  500.00|    2020-01-12|  2020-01-17|
      2|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 1000.00|    2020-01-14|  2020-02-27|
      3|Яковлев Г.Р. |Т330ТТ      |Превышение скорости(от 20 до 40)|  500.00|    2020-01-23|  2020-02-23|
      4|Яковлев Г.Р. |М701АА      |Превышение скорости(от 20 до 40)|        |    2020-01-12|            |
      5|Колесов С.П. |К892АХ      |Превышение скорости(от 20 до 40)|        |    2020-02-01|            |
      6|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)|        |    2020-02-14|            |
      7|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    |        |    2020-02-23|            |
      8|Яковлев Г.Р. |Т330ТТ      |Проезд на запрещающий сигнал    |        |    2020-03-03|            |
```

<hr style="margin-left: 25%; margin-right: 25%;" dashed></details>

<details><br><summary>Таблицы после</summary>

```sql
SELECT * FROM traffic_violation;
```
```text
violation_id|violation                       |sum_fine|
------------+--------------------------------+--------+
           1|Превышение скорости(от 20 до 40)|  500.00|
           2|Превышение скорости(от 40 до 60)| 1000.00|
           3|Проезд на запрещающий сигнал    | 1000.00|
```

<p align="center">~~~</p>

```sql
SELECT * FROM fine;
```
```text
fine_id|name         |number_plate|violation                       |sum_fine|date_violation|date_payment|
-------+-------------+------------+--------------------------------+--------+--------------+------------+
      1|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)|  500.00|    2020-01-12|  2020-01-17|
      2|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 1000.00|    2020-01-14|  2020-02-27|
      3|Яковлев Г.Р. |Т330ТТ      |Превышение скорости(от 20 до 40)|  500.00|    2020-01-23|  2020-02-23|
      4|Яковлев Г.Р. |М701АА      |Превышение скорости(от 20 до 40)|  500.00|    2020-01-12|            |
      5|Колесов С.П. |К892АХ      |Превышение скорости(от 20 до 40)|  500.00|    2020-02-01|            |
      6|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)| 1000.00|    2020-02-14|            |
      7|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 1000.00|    2020-02-23|            |
      8|Яковлев Г.Р. |Т330ТТ      |Проезд на запрещающий сигнал    | 1000.00|    2020-03-03|            |
```

<hr style="margin-left: 25%; margin-right: 25%;" dashed></details>

<!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ -->

---

<h3 id="2" align="center">Задание 2</h3>

Вывести фамилию, номер машины и нарушение только для тех водителей, которые на
одной машине нарушили одно и то же правило два и более раз. При этом
учитывать все нарушения, независимо от того оплачены они или нет. Информацию
отсортировать в алфавитном порядке, сначала по фамилии водителя, потом по
номеру машины и, наконец, по нарушению.

<details><br><summary>Таблицы</summary>

```sql
SELECT * FROM traffic_violation;
```
```text
violation_id|violation                       |sum_fine|
------------+--------------------------------+--------+
           1|Превышение скорости(от 20 до 40)|  500.00|
           2|Превышение скорости(от 40 до 60)| 1000.00|
           3|Проезд на запрещающий сигнал    | 1000.00|
```

<p align="center">~~~</p>

```sql
SELECT * FROM fine;
```
```text
fine_id|name         |number_plate|violation                       |sum_fine|date_violation|date_payment|
-------+-------------+------------+--------------------------------+--------+--------------+------------+
      1|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)|  500.00|    2020-01-12|  2020-01-17| <-1
      2|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 1000.00|    2020-01-14|  2020-02-27| <-1
      3|Яковлев Г.Р. |Т330ТТ      |Превышение скорости(от 20 до 40)|  500.00|    2020-01-23|  2020-02-23|
      4|Яковлев Г.Р. |М701АА      |Превышение скорости(от 20 до 40)|  500.00|    2020-01-12|            |
      5|Колесов С.П. |К892АХ      |Превышение скорости(от 20 до 40)|  500.00|    2020-02-01|            |
      6|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)| 1000.00|    2020-02-14|            | <-2
      7|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 1000.00|    2020-02-23|            | <-2
      8|Яковлев Г.Р. |Т330ТТ      |Проезд на запрещающий сигнал    | 1000.00|    2020-03-03|            |
```

<hr style="margin-left: 25%; margin-right: 25%;" dashed></details>

```sql
  SELECT name,
         number_plate,
         violation
    FROM fine
GROUP BY name,
         number_plate,
         violation
  HAVING COUNT(*) > 1
ORDER BY name ASC,
         number_plate ASC,
         violation ASC;
```
```text
name         |number_plate|violation                       |
-------------+------------+--------------------------------+
Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    |
Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)|
```

<!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ -->

---

<h3 id="3" align="center">Задание 3</h3>

В таблице fine увеличить в два раза сумму __неоплаченных__ штрафов для для тех
водителей, которые на одной машине нарушили одно и то же правило два и более
раз.

<details><br><summary>Таблицы до</summary>

```sql
SELECT * FROM traffic_violation;
```
```text
violation_id|violation                       |sum_fine|
------------+--------------------------------+--------+
           1|Превышение скорости(от 20 до 40)|  500.00|
           2|Превышение скорости(от 40 до 60)| 1000.00|
           3|Проезд на запрещающий сигнал    | 1000.00|
```

<p align="center">~~~</p>

```sql
SELECT * FROM fine;
```
```text
fine_id|name         |number_plate|violation                       |sum_fine|date_violation|date_payment|
-------+-------------+------------+--------------------------------+--------+--------------+------------+
      1|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)|  500.00|    2020-01-12|  2020-01-17| <-1
      2|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 1000.00|    2020-01-14|  2020-02-27| <-1
      3|Яковлев Г.Р. |Т330ТТ      |Превышение скорости(от 20 до 40)|  500.00|    2020-01-23|  2020-02-23|
      4|Яковлев Г.Р. |М701АА      |Превышение скорости(от 20 до 40)|  500.00|    2020-01-12|            |
      5|Колесов С.П. |К892АХ      |Превышение скорости(от 20 до 40)|  500.00|    2020-02-01|            |
      6|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)| 1000.00|    2020-02-14|            | <-2
      7|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 1000.00|    2020-02-23|            | <-2
      8|Яковлев Г.Р. |Т330ТТ      |Проезд на запрещающий сигнал    | 1000.00|    2020-03-03|            |
```

<hr style="margin-left: 25%; margin-right: 25%;" dashed></details>

<details><br><summary>Под-запрос</summary>

```sql
  SELECT name,
         number_plate,
         violation
    FROM (SELECT name,
                 number_plate,
                 violation
            FROM fine) as temp
GROUP BY name,
         number_plate,
         violation
  HAVING COUNT(*) > 1;
```
```text
name         |number_plate|violation                       |
-------------+------------+--------------------------------+
Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)|
Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    |
```

<hr style="margin-left: 25%; margin-right: 25%;" dashed></details>

```sql
UPDATE fine
   SET sum_fine = sum_fine * 2
 WHERE ISNULL(date_payment)
   AND (name, number_plate, violation) IN (  SELECT name,
                                                    number_plate,
                                                    violation
                                               FROM (SELECT name,
                                                            number_plate,
                                                            violation
                                                       FROM fine) as temp
                                           GROUP BY name,
                                                    number_plate,
                                                    violation
                                             HAVING COUNT(*) > 1);
```
```text
fine_id|name         |number_plate|violation                       |sum_fine|date_violation|date_payment|
-------+-------------+------------+--------------------------------+--------+--------------+------------+
      1|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)|  500.00|    2020-01-12|  2020-01-17|
      2|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 1000.00|    2020-01-14|  2020-02-27|
      3|Яковлев Г.Р. |Т330ТТ      |Превышение скорости(от 20 до 40)|  500.00|    2020-01-23|  2020-02-23|
      4|Яковлев Г.Р. |М701АА      |Превышение скорости(от 20 до 40)|  500.00|    2020-01-12|            |
      5|Колесов С.П. |К892АХ      |Превышение скорости(от 20 до 40)|  500.00|    2020-02-01|            |
      6|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)| 2000.00|    2020-02-14|            | <-x2
      7|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 2000.00|    2020-02-23|            | <-x2
      8|Яковлев Г.Р. |Т330ТТ      |Проезд на запрещающий сигнал    | 1000.00|    2020-03-03|            |
```

<!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ -->

---

<h3 id="4" align="center">Задание 4</h3>

Водители оплачивают свои штрафы. В таблице payment занесены даты их оплаты.

Необходимо:
1. в таблицу fine занести дату оплаты соответствующего штрафа из таблицы payment;
2. уменьшить начисленный штраф в таблице fine в два раза (только для тех
штрафов, информация о которых занесена в таблицу payment) , если оплата
произведена не позднее 20 дней со дня нарушения.

<p align="center">~~~</p>

<details><br><summary>Таблица payment</summary>

```sql
SELECT * FROM payment;
```
```text
payment_id|name        |number_plate|violation                       |date_violation|date_payment|
----------+------------+------------+--------------------------------+--------------+------------+
         1|Яковлев Г.Р.|М701АА      |Превышение скорости(от 20 до 40)|    2020-01-12|  2020-01-22|
         2|Баранов П.Е.|Р523ВТ      |Превышение скорости(от 40 до 60)|    2020-02-14|  2020-03-06|
         3|Яковлев Г.Р.|Т330ТТ      |Проезд на запрещающий сигнал    |    2020-03-03|  2020-03-23|
```

<hr style="margin-left: 25%; margin-right: 25%;" dashed></details>

<details><br><summary>Таблица fine до</summary>

```sql
SELECT * FROM fine;
```
```text
fine_id|name         |number_plate|violation                       |sum_fine|date_violation|date_payment|
-------+-------------+------------+--------------------------------+--------+--------------+------------+
      1|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)|  500.00|    2020-01-12|  2020-01-17|
      2|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 1000.00|    2020-01-14|  2020-02-27|
      3|Яковлев Г.Р. |Т330ТТ      |Превышение скорости(от 20 до 40)|  500.00|    2020-01-23|  2020-02-23|
      4|Яковлев Г.Р. |М701АА      |Превышение скорости(от 20 до 40)|  500.00|    2020-01-12|            | <-
      5|Колесов С.П. |К892АХ      |Превышение скорости(от 20 до 40)|  500.00|    2020-02-01|            |
      6|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)| 2000.00|    2020-02-14|            | <-
      7|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 2000.00|    2020-02-23|            |
      8|Яковлев Г.Р. |Т330ТТ      |Проезд на запрещающий сигнал    | 1000.00|    2020-03-03|            | <-
```

<hr style="margin-left: 25%; margin-right: 25%;" dashed></details>

```sql
UPDATE fine AS f,
       payment AS p
   SET f.date_payment = p.date_payment,
       f.sum_fine = ROUND(f.sum_fine * @discount, 2)
 WHERE f.name = p.name
   AND f.number_plate = p.number_plate
   AND f.violation = p.violation
   AND f.date_violation = p.date_violation
   AND @discount := IF(DATEDIFF(p.date_payment, f.date_violation) <= 20, 0.5, 1);
```
```text
fine_id|name         |number_plate|violation                       |sum_fine|date_violation|date_payment|
-------+-------------+------------+--------------------------------+--------+--------------+------------+
      1|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)|  250.00|    2020-01-12|  2020-01-17|
      2|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 1000.00|    2020-01-14|  2020-02-27|
      3|Яковлев Г.Р. |Т330ТТ      |Превышение скорости(от 20 до 40)|  500.00|    2020-01-23|  2020-02-23|
      4|Яковлев Г.Р. |М701АА      |Превышение скорости(от 20 до 40)|  250.00|    2020-01-12|  2020-01-22| <-50%
      5|Колесов С.П. |К892АХ      |Превышение скорости(от 20 до 40)|  500.00|    2020-02-01|            |
      6|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)| 2000.00|    2020-02-14|  2020-03-06| <-0%
      7|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 2000.00|    2020-02-23|            |
      8|Яковлев Г.Р. |Т330ТТ      |Проезд на запрещающий сигнал    |  500.00|    2020-03-03|  2020-03-23| <-50%
```

<!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ -->

---

<h3 id="5" align="center">Задание 5</h3>

Создать новую таблицу back_payment, куда внести информацию о неоплаченных
штрафах (Фамилию и инициалы водителя, номер машины, нарушение, сумму штрафа и 
дату нарушения) из таблицы fine.

<details><br><summary>Таблица fine</summary>

```sql
SELECT * FROM fine;
```
```text
fine_id|name         |number_plate|violation                       |sum_fine|date_violation|date_payment|
-------+-------------+------------+--------------------------------+--------+--------------+------------+
      1|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)|  500.00|    2020-01-12|  2020-01-17|
      2|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 1000.00|    2020-01-14|  2020-02-27|
      3|Яковлев Г.Р. |Т330ТТ      |Превышение скорости(от 20 до 40)|  500.00|    2020-01-23|  2020-02-23|
      4|Яковлев Г.Р. |М701АА      |Превышение скорости(от 20 до 40)|  250.00|    2020-01-12|  2020-01-22|
      5|Колесов С.П. |К892АХ      |Превышение скорости(от 20 до 40)|  500.00|    2020-02-01|            | <-
      6|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)| 2000.00|    2020-02-14|  2020-03-06|
      7|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 2000.00|    2020-02-23|            | <-
      8|Яковлев Г.Р. |Т330ТТ      |Проезд на запрещающий сигнал    |  500.00|    2020-03-03|  2020-03-23|
```

<hr style="margin-left: 25%; margin-right: 25%;" dashed></details>

```sql
CREATE TABLE IF NOT EXISTS back_payment
                    SELECT name,
                           number_plate,
                           violation,
                           sum_fine,
                           date_violation
                      FROM fine
                     WHERE ISNULL(date_payment);
```
```text
name         |number_plate|violation                       |sum_fine|date_violation|
-------------+------------+--------------------------------+--------+--------------+
Колесов С.П. |К892АХ      |Превышение скорости(от 20 до 40)|  500.00|    2020-02-01|
Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 2000.00|    2020-02-23|
```

<!-- @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ -->

---

<h3 id="6" align="center">Задание 6</h3>

Удалить из таблицы fine информацию о нарушениях, совершенных раньше 1 февраля
2020 года.

```sql
DELETE FROM fine
      WHERE DATEDIFF(date_violation, '2020-02-01') < 0;
```

<details><br><summary>Таблица fine до</summary>

```sql
SELECT * FROM fine;
```
```text
fine_id|name         |number_plate|violation                       |sum_fine|date_violation|date_payment|
-------+-------------+------------+--------------------------------+--------+--------------+------------+
      1|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)|  500.00|    2020-01-12|  2020-01-17| <-x
      2|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 1000.00|    2020-01-14|  2020-02-27| <-x
      3|Яковлев Г.Р. |Т330ТТ      |Превышение скорости(от 20 до 40)|  500.00|    2020-01-23|  2020-02-23| <-x
      4|Яковлев Г.Р. |М701АА      |Превышение скорости(от 20 до 40)|  250.00|    2020-01-12|  2020-01-22| <-x
      5|Колесов С.П. |К892АХ      |Превышение скорости(от 20 до 40)|  500.00|    2020-02-01|            |
      6|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)| 2000.00|    2020-02-14|  2020-03-06|
      7|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 2000.00|    2020-02-23|            |
      8|Яковлев Г.Р. |Т330ТТ      |Проезд на запрещающий сигнал    |  500.00|    2020-03-03|  2020-03-23|
```

<hr style="margin-left: 25%; margin-right: 25%;" dashed></details>

<details><br><summary>Таблица fine после</summary>

```sql
SELECT * FROM fine;
```
```text
fine_id|name         |number_plate|violation                       |sum_fine|date_violation|date_payment|
-------+-------------+------------+--------------------------------+--------+--------------+------------+
      5|Колесов С.П. |К892АХ      |Превышение скорости(от 20 до 40)|  500.00|    2020-02-01|            |
      6|Баранов П.Е. |Р523ВТ      |Превышение скорости(от 40 до 60)| 2000.00|    2020-02-14|  2020-03-06|
      7|Абрамова К.А.|О111АВ      |Проезд на запрещающий сигнал    | 2000.00|    2020-02-23|            |
      8|Яковлев Г.Р. |Т330ТТ      |Проезд на запрещающий сигнал    |  500.00|    2020-03-03|  2020-03-23|
```

<hr style="margin-left: 25%; margin-right: 25%;" dashed></details>