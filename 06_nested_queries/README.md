- [Использование вложенных запросов (1х1)](#1)
- [Использование вложенных запросов (n x 1)](#2)
- [Использование вложенных запросов (n x n)](#3)
- [Операторы ANY и ALL для вложенных запросов (n x 1)](#4)

---

- Вложенный запрос (1 х 1) - запрос возвращающий одну строку и одну колонку;
- Вложенный запрос (n х 1) - запрос возвращающий n строк и одну колонку;
- Вложенный запрос (n х n) - запрос возвращающий n строк и n колонок;

---

<h3 id="1" align="center">Использование вложенных запросов (1х1)</h3>

Пример 1:

Вывести информацию (автора, название и цену) о  книгах, цены которых меньше или
равны средней цене книг на складе. Информацию вывести в отсортированном по
убыванию цены виде. Среднее вычислить как среднее по цене книги.

```text
- выбрать таблицу book;
- отсеять все записи price которых меньше средней;
- подготовить таблицу с колонками author, title, price;
- вывести таблицу отсортированную по убыванию значения price.
```
```sql
SELECT AVG(price)
  FROM book;
```
```text
AVG(price)|
----------+
600.166667|
```
```sql
  SELECT author,
         title,
         price
    FROM book
   WHERE price <= (SELECT AVG(price)
                     FROM book)
ORDER BY price DESC;
```
```text
author          |title        |price |
----------------+-------------+------+
Булгаков М.А.   |Белая гвардия|540.50|
Достоевский Ф.М.|Игрок        |480.50|
Достоевский Ф.М.|Идиот        |460.00|
```

<p align="center">~~~</p>

Пример 2:

Вывести информацию о книгах, количество экземпляров которых отличается от
среднего количества экземпляров книг на складе более чем на 3. То есть нужно
вывести и те книги, количество экземпляров которых меньше среднего на 3, или
больше среднего на 3.

```text
- выбрать таблицу book;
- выбрать только те книги кол-во которых на 3 меньше|больше среднего количества
  каждой книги;
- вывести таблицу с колонками title, author, amount.
```
```sql
SELECT title,
       author,
       amount
  FROM book
 WHERE (SELECT @avg_amount := AVG(amount)
          FROM book)
   AND ABS(amount - @avg_amount) > 3;
```
```text
title                |author          |amount|
---------------------+----------------+------+
Мастер и Маргарита   |Булгаков М.А.   |     3|
Братья Карамазовы    |Достоевский Ф.М.|     3|
Стихотворения и поэмы|Есенин С.А.     |    15|
```

<p align="center">~~~</p>

Пример 3:

Вывести информацию (author, title, price) о тех книгах, цены которых
превышают минимальную цену книги на складе не более чем на 150 рублей в
отсортированном по возрастанию цены виде.

```text
- выбрать таблицу book;
- отсечь книги цена которых больше на 150, минимальной цены в выборке;
- подготовить таблицу с колонками author, title, price;
- вывести таблицу отсортированную по возрастанию цены.
```
```sql
  SELECT author,
         title,
         price
    FROM book
   WHERE (SELECT @min_price := MIN(price)
            FROM book)
         AND price <= @min_price + 150
ORDER BY price ASC;
```
```text
author          |title        |price |
----------------+-------------+------+
Достоевский Ф.М.|Идиот        |460.00|
Достоевский Ф.М.|Игрок        |480.50|
Булгаков М.А.   |Белая гвардия|540.50|
```

---

<h3 id="2" align="center">Использование вложенных запросов (n x 1)</h3>

Вложенный запрос может возвращать несколько значений одного столбца.
Тогда его можно использовать в разделе `WHERE` совместно с оператором `IN`.

```sql
WHERE имя_столбца [NOT] IN (вложенный запрос, возвращающий один столбец)
```

<p align="center">~~~</p>

Пример 1:

Вывести информацию о книгах тех авторов, общее количество экземпляров книг
которых не менее 12.

```text
- выбрать таблицу book;
- отсеять авторов у которых общее кол-во экземпляров книг меньше 12:
    - получить авторов кол-во экземпляров книг которых меньше 12:
        - выбрать таблицу book;
        - сгруппировать по авторам;
        - отфильтровать группы у которых SUM(amount) < 12;
        - вывести таблицу с полем author.
- вывести таблицу с полями title, author, amount, price.
```
```sql
-- получить авторов кол-во экземпляров книг которых меньше 12;
  SELECT author
    FROM book
GROUP BY author
  HAVING SUM(amount) < 12;

author       |
-------------+
Булгаков М.А.|
```
```sql
SELECT title,
       author,
       amount,
       price
  FROM book
 WHERE author NOT IN (  SELECT author
                          FROM book
                      GROUP BY author
                        HAVING SUM(amount) < 12);
```
```text
title                |author          |amount|price |
---------------------+----------------+------+------+
Идиот                |Достоевский Ф.М.|    10|460.00|
Братья Карамазовы    |Достоевский Ф.М.|     3|799.01|
Игрок                |Достоевский Ф.М.|    10|480.50|
Стихотворения и поэмы|Есенин С.А.     |    15|650.00|
```

<p align="center">~~~</p>

Задание:

Вывести информацию (author, title, amount) о тех книгах, количество экземпляров
которых в таблице book не дублируется.

```text
- выбрать таблицу book;
- отсеять книги у которых amount дублируется в таблице:
    - получить таблицу с уникальным значением amount:
        - выбрать таблицу book;
        - сгруппировать по полю amount;
        - отсечь все группы у которых кол-во строк > 1 -> COUNT(*) > 1;
        - вернуть табличку с уникальными amount.
- вывести таблицу с полями author, title, amount.
```
```sql
  SELECT amount
    FROM book
GROUP BY amount
  HAVING COUNT(*) = 1;

amount|
------+
     5|
    15|
```
```sql
SELECT author,
       title,
       amount
  FROM book
 WHERE amount IN (  SELECT amount
                      FROM book
                  GROUP BY amount
                    HAVING COUNT(*) = 1);
```
```text
author       |title                |amount|
-------------+---------------------+------+
Булгаков М.А.|Белая гвардия        |     5|
Есенин С.А.  |Стихотворения и поэмы|    15|
```

---

<h3 id="3" align="center">Использование вложенных запросов (n x n)</h3>

Логика такая-же как и при работе с вложенным запросом (n x 1) только в отличии
от него:
  - проверяются больше одной колонки за раз;
  - __кол-во и название__ сравниваемых полей с полями возвращенными
    под-запросом __должны совпадать__.

<p align="center">~~~</p>

Синтаксис

```sql
SELECT <fields>
  FROM <tbl_name>
 WHERE (<fiend1>, <field2>, <field3>) [NOT] IN (SELECT <field1>,
                                                       <field2>,
                                                       <field3>
                                                  FROM <tbl_name>);
```

---

<h3 id="4" align="center">Операторы ANY и ALL для вложенных запросов (n x 1)</h3>

__Важно! Операторы ALL и ANY можно использовать только с вложенными запросами.__
В примерах ниже (10, 12) приводится как результат вложенного запроса просто для
того, чтобы показать как эти операторы работают. В запросах так записывать нельзя.

<p align="center">~~~</p>

### ANY - ЛЮБОГО.

```sql
amount > ANY (10, 12)   -- amount > 10 OR amount > 12
amount < ANY (10, 12)   -- amount < 10 OR amount < 12
amount = ANY (10, 12)   -- amount = 10 OR amount = 12
amount != ANY (10, 12)  -- amount != 10 OR amount != 12
```
```python
any(amount > value for value in (10, 12))   # amount > 10 or amount > 12
any(amount < value for value in (10, 12))   # amount < 10 or amount < 12
any(amount == value for value in (10, 12))  # amount == 10 or amount == 12
any(amount != value for value in (10, 12))  # amount != 10 or amount != 12
```

<p align="center">~~~</p>

### ALL - КАЖДОГО.
```sql
amount > ALL (10, 12)   -- amount > 10 AND amount > 12
amount < ALL (10, 12)   -- amount < 10 AND amount < 12
amount = ALL (10, 12)   -- amount = 10 AND amount = 12
amount != ALL (10, 12)  -- amount != 10 AND amount != 12
```
```python
all(amount > value for value in (10, 12))   # amount > 10 and amount > 12
all(amount < value for value in (10, 12))   # amount < 10 and amount < 12
all(amount == value for value in (10, 12))  # amount == 10 and amount == 12
all(amount != value for value in (10, 12))  # amount != 10 and amount != 12
```

<p align="center">~~~</p>

Пример 1:

Вывести информацию о тех книгах, количество которых меньше самого маленького
среднего количества книг каждого автора.

```text
- выбрать таблицу book;
- отсеять все книги кол-во которых больше чем минимальное среднее кол-во книг
  по группам авторов:
    - получить таблицу со средним кол-вом книг для каждого автора:
        - выбрать таблицу book;
        - сгруппировать по авторам;
        - вывести таблицу с полем среднего кол-ва книг для каждой группы;
- вывести таблицу с полями title, author, amount, price.
```
```sql
-- получить таблицу со средним кол-вом книг для каждого автора;
  SELECT AVG(amount)
    FROM book
GROUP BY author;

AVG(amount)|
-----------+
     4.0000|
     7.6667|
    15.0000|
```
```sql
SELECT title,
       author,
       amount,
       price
  FROM book
 WHERE amount < ALL (  SELECT AVG(amount)  -- amount меньше КАЖДОГО значения из (...);
                         FROM book
                     GROUP BY author);
```
```text
title             |author          |amount|price |
------------------+----------------+------+------+
Мастер и Маргарита|Булгаков М.А.   |     3|670.99|
Братья Карамазовы |Достоевский Ф.М.|     3|799.01|
```

<p align="center">~~~</p>

Пример 2:

Вывести информацию о тех книгах, количество которых меньше самого большого
среднего количества книг каждого автора.

```text
- выбрать таблицу book;
- отсеять те книги, кол-во которых больше максимального среднего кол-ва книг,
  по группам авторов;
    - получить таблицу со средними значениями кол-ва книг у каждого автора:
        - выбрать таблицу book;
        - сгруппировать её по авторам;
        - вывести таблицу с колонкой со средним кол-во книг у каждой группы;
- вывести таблицу с полями title, author, amount, price.
```
```sql
-- получить таблицу со средними значениями кол-ва книг у каждого автора;
  SELECT AVG(amount)
    FROM book
GROUP BY author;

AVG(amount)|
-----------+
     4.0000|
     7.6667|
    15.0000|
```
```sql
SELECT title,
       author,
       amount,
       price
  FROM book
 WHERE amount < ANY (  SELECT AVG(amount)  -- amount меньше ЛЮБОГО значения из (...);
                         FROM book
                     GROUP BY author);
```
```text
title             |author          |amount|price |
------------------+----------------+------+------+
Мастер и Маргарита|Булгаков М.А.   |     3|670.99|
Белая гвардия     |Булгаков М.А.   |     5|540.50|
Идиот             |Достоевский Ф.М.|    10|460.00|
Братья Карамазовы |Достоевский Ф.М.|     3|799.01|
Игрок             |Достоевский Ф.М.|    10|480.50|
```

<p align="center">~~~</p>

Задание:

Вывести информацию о книгах(author, title, price), цена которых меньше самой
большой из минимальных цен, вычисленных для каждого автора.

```text
- выбрать таблицу book;
- отсечь книги цена которых больше, самой большой из минимальных цен,
  вычисленных для каждого автора:
    - получить таблицу с самыми дешевыми ценами для каждой группы авторов:
        - выбрать таблицу book;
        - сгруппировать по авторам;
        - вернуть таблицу с полем содержащим цену самой дешевой книги автора;
- вывести таблицу с полями author, title, price.
```
```sql
-- получить таблицу с самыми дешевыми ценами для каждой группы авторов;
  SELECT MIN(price)
    FROM book
GROUP BY author;

MIN(price)|
----------+
    540.50|
    460.00|
    650.00|
```
```sql
SELECT author,
       title,
       price
  FROM book
 WHERE price < ANY (  SELECT MIN(price)  -- price меньше ЛЮБОГО значения из (...);
                        FROM book
                    GROUP BY author);
```
```text
author          |title        |price |
----------------+-------------+------+
Булгаков М.А.   |Белая гвардия|540.50|
Достоевский Ф.М.|Идиот        |460.00|
Достоевский Ф.М.|Игрок        |480.50|
```

---

__Финальное задание:__

Посчитать сколько и каких экземпляров книг нужно заказать поставщикам, чтобы на
складе стало одинаковое количество экземпляров каждой книги, равное значению
самого большего количества экземпляров одной книги на складе.

Вывести (title, author, amount, Заказ). Последнему столбцу присвоить имя Заказ,
количество заказываемых экземпляров книг.

В результат не включать книги, которые заказывать не нужно.

```text
- получить таблицу book;
- отсеять книги кол-во которых равна максимальному кол-ву отдельной книги:
    - вывести amount книги с самым большим amount во всей таблице:
        - получить таблицу book;
        - вывести поле с самым большим amount.
- рассчитать значение для поля Заказ (максимальное найденное кол-во - amount);
- вывести таблицу с полями (title, author, amount, Заказ).
```
```sql
SELECT @max_amount := MAX(amount)
  FROM book;

@max_amount := MAX(amount)|
--------------------------+
                        15|
```
```sql
SELECT title,
       author,
       amount,
       @max_amount - amount AS Заказ
  FROM book
 WHERE amount < (SELECT @max_amount := MAX(amount)
                   FROM book);
```
```text
title             |author          |amount|Заказ|
------------------+----------------+------+-----+
Мастер и Маргарита|Булгаков М.А.   |     3|   12| <- 15 - 3 = 12
Белая гвардия     |Булгаков М.А.   |     5|   10| <- 15 - 5 = 10
Идиот             |Достоевский Ф.М.|    10|    5| <- 15 - 10 = 5
Братья Карамазовы |Достоевский Ф.М.|     3|   12| <- 15 - 3 = 12
Игрок             |Достоевский Ф.М.|    10|    5| <- 15 - 10 = 5
```